<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nourish â€” Calorie Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0e0c;
    --surface: #1a1916;
    --surface2: #242220;
    --border: #2e2c29;
    --accent: #e8c97a;
    --accent2: #c4a85a;
    --text: #f0ece4;
    --text2: #9a9690;
    --text3: #5a5854;
    --green: #7ab87a;
    --red: #c47a6a;
    --blue: #7ab0c8;
    --protein: #c4847a;
    --carbs: #c4b47a;
    --fat: #7ab0a8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  .app {
    max-width: 720px;
    margin: 0 auto;
    padding: 24px 16px 80px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .logo span {
    font-style: italic;
    color: var(--text2);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    display: block;
    margin-top: -2px;
    letter-spacing: 0.5px;
  }

  /* Date navigator */
  .date-nav {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .date-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text2);
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }

  .date-btn:hover { border-color: var(--accent); color: var(--accent); }

  .date-display {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--text);
    cursor: pointer;
    padding: 6px 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    transition: border-color 0.15s;
  }

  .date-display:hover { border-color: var(--accent); }

  #date-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  /* Summary ring */
  .summary {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 24px;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
  }

  .ring-wrap {
    position: relative;
    width: 110px;
    height: 110px;
    flex-shrink: 0;
  }

  .ring-wrap svg { transform: rotate(-90deg); }

  .ring-center {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .ring-cal {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    color: var(--text);
    line-height: 1;
  }

  .ring-label {
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 2px;
  }

  .macros-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
  }

  .macro-card {
    background: var(--surface2);
    border-radius: 10px;
    padding: 10px 12px;
  }

  .macro-label {
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 4px;
  }

  .macro-value {
    font-family: 'DM Mono', monospace;
    font-size: 18px;
    font-weight: 500;
  }

  .macro-value.protein { color: var(--protein); }
  .macro-value.carbs { color: var(--carbs); }
  .macro-value.fat { color: var(--fat); }

  .macro-unit {
    font-size: 11px;
    color: var(--text3);
    margin-left: 2px;
  }

  .macro-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 6px;
    overflow: hidden;
  }

  .macro-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.4s ease;
  }

  /* Goal setting */
  .goal-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .goal-label { font-size: 12px; color: var(--text3); }

  .goal-input {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 6px;
    width: 80px;
    transition: border-color 0.15s;
  }

  .goal-input:focus { outline: none; border-color: var(--accent); }

  /* Search area */
  .search-section {
    margin-bottom: 20px;
  }

  .search-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text3);
    margin-bottom: 8px;
  }

  .search-box {
    display: flex;
    gap: 8px;
  }

  .search-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    padding: 11px 14px;
    border-radius: 10px;
    transition: border-color 0.15s;
  }

  .search-input::placeholder { color: var(--text3); }
  .search-input:focus { outline: none; border-color: var(--accent); }

  .search-btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 10px;
    padding: 0 18px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }

  .search-btn:hover { background: var(--accent2); }
  .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Results */
  .results {
    margin-top: 8px;
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    display: none;
  }

  .results.visible { display: block; }

  .result-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
    gap: 8px;
  }

  .result-item:last-child { border-bottom: none; }
  .result-item:hover { background: var(--surface); }

  .result-name {
    font-size: 13px;
    color: var(--text);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .result-brand {
    font-size: 11px;
    color: var(--text3);
  }

  .result-cals {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    white-space: nowrap;
  }

  .result-source {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
  }

  .source-db { background: rgba(122,184,122,0.15); color: var(--green); }
  .source-ai { background: rgba(122,176,200,0.15); color: var(--blue); }

  .ai-estimate-row {
    border-top: 1px solid var(--border);
    background: rgba(122,176,200,0.04);
  }
  .ai-estimate-row:hover { background: rgba(122,176,200,0.1) !important; }

  /* Quantity modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.visible { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    width: 320px;
    max-width: 90vw;
  }

  .modal-title {
    font-family: 'DM Serif Display', serif;
    font-size: 18px;
    margin-bottom: 4px;
  }

  .modal-subtitle {
    font-size: 12px;
    color: var(--text3);
    margin-bottom: 20px;
  }

  .modal-fields { display: flex; flex-direction: column; gap: 12px; }

  .field-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text3);
    margin-bottom: 5px;
  }

  .field-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    padding: 9px 12px;
    border-radius: 8px;
    transition: border-color 0.15s;
  }

  .field-input:focus { outline: none; border-color: var(--accent); }

  .modal-preview {
    background: var(--surface2);
    border-radius: 8px;
    padding: 10px 12px;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text2);
    font-family: 'DM Mono', monospace;
    min-height: 36px;
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 20px;
  }

  .btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
  }

  .btn-primary { background: var(--accent); color: var(--bg); }
  .btn-primary:hover { background: var(--accent2); }
  .btn-secondary { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--text2); }

  /* Food log */
  .log-section { margin-top: 4px; }

  .log-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .log-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text3);
  }

  .log-count {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text3);
  }

  .log-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
    font-size: 13px;
    border: 1px dashed var(--border);
    border-radius: 12px;
  }

  .log-empty-icon {
    font-size: 28px;
    margin-bottom: 8px;
    opacity: 0.4;
  }

  .log-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 6px;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .log-item-info { flex: 1; min-width: 0; }

  .log-item-name {
    font-size: 13px;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 3px;
  }

  .log-item-meta {
    display: flex;
    gap: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text3);
    flex-wrap: wrap;
  }

  .log-item-meta span { white-space: nowrap; }
  .log-item-meta .p { color: var(--protein); }
  .log-item-meta .c { color: var(--carbs); }
  .log-item-meta .f { color: var(--fat); }

  .log-item-cals {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: var(--accent);
    white-space: nowrap;
  }

  .log-item-src {
    font-size: 9px;
    padding: 2px 5px;
    border-radius: 3px;
    align-self: flex-start;
  }

  .delete-btn {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    border-radius: 4px;
    transition: color 0.15s;
    line-height: 1;
  }

  .delete-btn:hover { color: var(--red); }

  /* Sheets export */
  .export-section {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }

  .export-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text3);
    margin-bottom: 12px;
  }

  .sheets-setup {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
  }

  .sheets-setup-title {
    font-size: 13px;
    color: var(--text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .sheets-setup p {
    font-size: 12px;
    color: var(--text3);
    line-height: 1.5;
    margin-bottom: 10px;
  }

  .sheets-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: border-color 0.15s;
  }

  .sheets-input:focus { outline: none; border-color: var(--accent); }
  .sheets-input::placeholder { color: var(--text3); }

  .export-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  .export-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 9px 14px;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
  }

  .export-btn-sheets {
    background: rgba(122,184,122,0.15);
    color: var(--green);
    border: 1px solid rgba(122,184,122,0.3);
  }
  .export-btn-sheets:hover { background: rgba(122,184,122,0.25); }
  .export-btn-sheets:disabled { opacity: 0.4; cursor: not-allowed; }

  .export-btn-csv {
    background: var(--surface2);
    color: var(--text2);
    border: 1px solid var(--border);
  }
  .export-btn-csv:hover { border-color: var(--text2); }

  /* AI key section */
  .ai-section {
    margin-top: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
  }

  .ai-section-title {
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .ai-section p {
    font-size: 11px;
    color: var(--text3);
    line-height: 1.5;
    margin-bottom: 8px;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 13px;
    opacity: 0;
    transition: all 0.25s;
    z-index: 200;
    white-space: nowrap;
    pointer-events: none;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .toast.success { border-color: rgba(122,184,122,0.5); color: var(--green); }
  .toast.error { border-color: rgba(196,122,106,0.5); color: var(--red); }

  .loading-dots::after {
    content: '...';
    animation: dots 1.2s steps(4, end) infinite;
  }

  @keyframes dots {
    0%, 100% { content: ''; }
    25% { content: '.'; }
    50% { content: '..'; }
    75% { content: '...'; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="logo">
      Nourish
      <span>daily food tracker</span>
    </div>
    <div class="date-nav">
      <button class="date-btn" onclick="changeDay(-1)">â€¹</button>
      <div class="date-display" onclick="document.getElementById('date-input').showPicker ? document.getElementById('date-input').showPicker() : document.getElementById('date-input').click()" id="date-display">Today</div>
      <input type="date" id="date-input" onchange="setDate(this.value)">
      <button class="date-btn" onclick="changeDay(1)">â€º</button>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary">
    <div class="ring-wrap">
      <svg width="110" height="110" viewBox="0 0 110 110">
        <circle cx="55" cy="55" r="46" fill="none" stroke="#2e2c29" stroke-width="8"/>
        <circle cx="55" cy="55" r="46" fill="none" stroke="#e8c97a" stroke-width="8"
          stroke-dasharray="289" stroke-dashoffset="289" stroke-linecap="round"
          id="cal-ring" style="transition: stroke-dashoffset 0.5s ease;"/>
      </svg>
      <div class="ring-center">
        <div class="ring-cal" id="total-cals">0</div>
        <div class="ring-label">kcal</div>
      </div>
    </div>

    <div>
      <div class="macros-grid">
        <div class="macro-card">
          <div class="macro-label">Protein</div>
          <div class="macro-value protein" id="total-protein">0<span class="macro-unit">g</span></div>
          <div class="macro-bar"><div class="macro-bar-fill" id="protein-bar" style="background:var(--protein);width:0%"></div></div>
        </div>
        <div class="macro-card">
          <div class="macro-label">Carbs</div>
          <div class="macro-value carbs" id="total-carbs">0<span class="macro-unit">g</span></div>
          <div class="macro-bar"><div class="macro-bar-fill" id="carbs-bar" style="background:var(--carbs);width:0%"></div></div>
        </div>
        <div class="macro-card">
          <div class="macro-label">Fat</div>
          <div class="macro-value fat" id="total-fat">0<span class="macro-unit">g</span></div>
          <div class="macro-bar"><div class="macro-bar-fill" id="fat-bar" style="background:var(--fat);width:0%"></div></div>
        </div>
      </div>
      <div class="goal-row">
        <span class="goal-label">Daily goal:</span>
        <input class="goal-input" type="number" id="cal-goal" value="2000" onchange="updateGoal()" placeholder="2000">
        <span class="goal-label">kcal</span>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="search-section">
    <div class="search-label">Add food</div>
    <div class="search-box">
      <input class="search-input" type="text" id="food-search" placeholder="Search food or describe a mealâ€¦" onkeydown="if(event.key==='Enter')searchFood()">
      <button class="search-btn" onclick="searchFood()" id="search-btn">Search</button>
    </div>
    <div class="results" id="results"></div>
  </div>

  <!-- Food Log -->
  <div class="log-section">
    <div class="log-header">
      <div class="log-title">Today's log</div>
      <div class="log-count" id="log-count">0 items</div>
    </div>
    <div id="food-log">
      <div class="log-empty">
        <div class="log-empty-icon">ðŸ¥—</div>
        Search for a food above to start logging
      </div>
    </div>
  </div>

  <!-- Export -->
  <div class="export-section">
    <div class="export-title">Export data</div>

    <div class="sheets-setup">
      <div class="sheets-setup-title">ðŸ“Š Google Sheets sync</div>
      <p>Paste your Google Apps Script Web App URL below to sync daily data directly into a spreadsheet. <a href="#" onclick="showSheetsHelp(); return false;" style="color:var(--accent)">How to set this up â†’</a></p>
      <input class="sheets-input" type="text" id="sheets-url" placeholder="https://script.google.com/macros/s/â€¦/exec" oninput="saveSheetsUrl()">
    </div>

    <div class="export-actions">
      <button class="export-btn export-btn-sheets" onclick="exportToSheets()" id="sheets-btn">
        â†‘ Sync to Sheets
      </button>
      <button class="export-btn export-btn-csv" onclick="exportCSV()">
        â†“ Download CSV
      </button>
    </div>

    <!-- AI key -->
    <div class="ai-section" style="margin-top:16px">
      <div class="ai-section-title">âœ¦ AI food estimation (optional)</div>
      <p>Add your Anthropic API key to enable intelligent estimation for foods not found in the database â€” like homemade dishes, restaurant meals, or complex descriptions.</p>
      <input class="sheets-input" type="password" id="ai-key" placeholder="sk-ant-â€¦" oninput="saveAiKey()" style="margin-bottom:0">
    </div>
  </div>

</div>

<!-- Quantity modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title" id="modal-food-name">Food name</div>
    <div class="modal-subtitle" id="modal-food-source">from database</div>
    <div class="modal-fields">
      <div>
        <div class="field-label">Quantity</div>
        <input class="field-input" type="number" id="modal-qty" value="100" oninput="updateModalPreview()" min="1">
      </div>
      <div>
        <div class="field-label">Unit</div>
        <select class="field-input" id="modal-unit" onchange="updateModalPreview()">
          <option value="g">grams (g)</option>
          <option value="portion">portion</option>
          <option value="ml">ml</option>
          <option value="oz">oz</option>
        </select>
      </div>
      <div>
        <div class="field-label">Nutritional preview (per serving)</div>
        <div class="modal-preview" id="modal-preview">â€”</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAdd()">Add to log</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentDate = todayStr();
let allData = JSON.parse(localStorage.getItem('nourish_data') || '{}');
let calGoal = parseInt(localStorage.getItem('nourish_goal') || '2000');
let selectedFood = null;

document.getElementById('cal-goal').value = calGoal;
document.getElementById('ai-key').value = localStorage.getItem('nourish_ai_key') || '';
document.getElementById('sheets-url').value = localStorage.getItem('nourish_sheets_url') || '';

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function formatDateDisplay(d) {
  const today = todayStr();
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  if (d === today) return 'Today';
  if (d === yesterday) return 'Yesterday';
  return new Date(d + 'T12:00:00').toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
}

function r(n) { return Math.round(n * 10) / 10; }
function ri(n) { return Math.round(n); }

function toast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 2500);
}

// â”€â”€ Date navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDate(val) {
  currentDate = val;
  document.getElementById('date-display').textContent = formatDateDisplay(val);
  document.getElementById('date-input').value = val;
  renderLog();
  renderSummary();
}

function changeDay(delta) {
  const d = new Date(currentDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  setDate(d.toISOString().slice(0, 10));
}

// Init date display
document.getElementById('date-display').textContent = formatDateDisplay(currentDate);
document.getElementById('date-input').value = currentDate;

// â”€â”€ Data helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDay() {
  return allData[currentDate] || [];
}

function saveDay(items) {
  allData[currentDate] = items;
  localStorage.setItem('nourish_data', JSON.stringify(allData));
}

function getTotals(items) {
  return items.reduce((acc, i) => ({
    cals: acc.cals + (i.cals || 0),
    protein: acc.protein + (i.protein || 0),
    carbs: acc.carbs + (i.carbs || 0),
    fat: acc.fat + (i.fat || 0)
  }), { cals: 0, protein: 0, carbs: 0, fat: 0 });
}

// â”€â”€ Summary render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary() {
  const items = getDay();
  const t = getTotals(items);
  const goal = calGoal;

  document.getElementById('total-cals').innerHTML = ri(t.cals);
  document.getElementById('total-protein').innerHTML = r(t.protein) + '<span class="macro-unit">g</span>';
  document.getElementById('total-carbs').innerHTML = r(t.carbs) + '<span class="macro-unit">g</span>';
  document.getElementById('total-fat').innerHTML = r(t.fat) + '<span class="macro-unit">g</span>';

  // Ring
  const pct = Math.min(t.cals / goal, 1);
  const circ = 289;
  document.getElementById('cal-ring').style.strokeDashoffset = circ - (pct * circ);
  document.getElementById('cal-ring').style.stroke = pct > 1 ? 'var(--red)' : pct > 0.85 ? 'var(--accent)' : 'var(--accent)';

  // Macro bars (rough % of typical daily)
  const proteinGoal = goal * 0.3 / 4; // 30% cals from protein
  const carbGoal = goal * 0.45 / 4;
  const fatGoal = goal * 0.25 / 9;

  document.getElementById('protein-bar').style.width = Math.min(t.protein / proteinGoal * 100, 100) + '%';
  document.getElementById('carbs-bar').style.width = Math.min(t.carbs / carbGoal * 100, 100) + '%';
  document.getElementById('fat-bar').style.width = Math.min(t.fat / fatGoal * 100, 100) + '%';
}

function updateGoal() {
  calGoal = parseInt(document.getElementById('cal-goal').value) || 2000;
  localStorage.setItem('nourish_goal', calGoal);
  renderSummary();
}

// â”€â”€ Log render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLog() {
  const items = getDay();
  const container = document.getElementById('food-log');
  document.getElementById('log-count').textContent = items.length + ' item' + (items.length !== 1 ? 's' : '');

  if (items.length === 0) {
    container.innerHTML = `<div class="log-empty"><div class="log-empty-icon">ðŸ¥—</div>Search for a food above to start logging</div>`;
    return;
  }

  container.innerHTML = items.map((item, i) => `
    <div class="log-item">
      <div class="log-item-info">
        <div class="log-item-name">${item.name}${item.qty ? ` <span style="color:var(--text3);font-size:11px">${item.qty}${item.unit}</span>` : ''}</div>
        <div class="log-item-meta">
          <span class="p">P ${r(item.protein)}g</span>
          <span class="c">C ${r(item.carbs)}g</span>
          <span class="f">F ${r(item.fat)}g</span>
        </div>
      </div>
      <span class="result-source log-item-src ${item.source === 'ai' ? 'source-ai' : 'source-db'}">${item.source === 'ai' ? 'AI' : 'DB'}</span>
      <div class="log-item-cals">${ri(item.cals)}</div>
      <button class="delete-btn" onclick="removeItem(${i})">Ã—</button>
    </div>
  `).join('');
}

function removeItem(idx) {
  const items = getDay();
  items.splice(idx, 1);
  saveDay(items);
  renderLog();
  renderSummary();
}

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function searchFood() {
  const q = document.getElementById('food-search').value.trim();
  if (!q) return;

  const btn = document.getElementById('search-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-dots">Searching</span>';

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';
  resultsEl.classList.remove('visible');

  let results = await searchOpenFoodFacts(q);

  btn.disabled = false;
  btn.textContent = 'Search';

  const aiKey = localStorage.getItem('nourish_ai_key');

  if (results.length === 0) {
    // No DB results at all
    if (aiKey) {
      resultsEl.innerHTML = `
        <div class="result-item" style="cursor:default">
          <span class="result-name" style="color:var(--text3)">No database matches found</span>
        </div>
        <div class="result-item ai-estimate-row" onclick="triggerAIEstimate('${q.replace(/'/g,"\\'")}')">
          <div style="flex:1">
            <div class="result-name" style="color:var(--blue)">âœ¦ Estimate "${q}" with AI</div>
            <div class="result-brand" style="color:var(--text3)">Claude will estimate calories & macros</div>
          </div>
          <span class="result-source source-ai">AI</span>
        </div>`;
    } else {
      resultsEl.innerHTML = `
        <div class="result-item" style="cursor:default">
          <div>
            <div class="result-name" style="color:var(--text2)">Not found in database</div>
            <div class="result-brand">Add your Anthropic API key below to enable AI estimation</div>
          </div>
        </div>`;
    }
  } else {
    // DB results found â€” show them + AI option at bottom
    const aiFooter = aiKey
      ? `<div class="result-item ai-estimate-row" onclick="triggerAIEstimate('${q.replace(/'/g,"\\'")}')">
          <div style="flex:1">
            <div class="result-name" style="color:var(--blue)">âœ¦ None of these match â€” estimate with AI instead</div>
            <div class="result-brand" style="color:var(--text3)">Claude will estimate "${q}" from scratch</div>
          </div>
          <span class="result-source source-ai">AI</span>
        </div>`
      : `<div class="result-item" style="cursor:default;opacity:0.5">
          <div class="result-name" style="color:var(--text3);font-size:12px">âœ¦ Add API key below to enable AI estimation if none match</div>
        </div>`;

    resultsEl.innerHTML = results.map((r, i) => {
      if (r.noKey) return '';
      return `<div class="result-item" onclick="selectFood(${i})">
        <div style="flex:1;min-width:0">
          <div class="result-name">${r.name}</div>
          ${r.brand ? `<div class="result-brand">${r.brand}</div>` : ''}
        </div>
        <span class="result-source ${r.source === 'ai' ? 'source-ai' : 'source-db'}">${r.source === 'ai' ? 'AI est.' : 'database'}</span>
        <div class="result-cals">${r.cals != null ? ri(r.cals) + ' kcal/100g' : ''}</div>
      </div>`;
    }).join('') + aiFooter;
  }

  resultsEl._results = results;
  resultsEl.classList.add('visible');
}

async function searchOpenFoodFacts(q) {
  try {
    const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(q)}&search_simple=1&action=process&json=1&page_size=8&fields=product_name,brands,nutriments`;
    const res = await fetch(url);
    const data = await res.json();

    return (data.products || [])
      .filter(p => p.product_name && p.nutriments?.['energy-kcal_100g'])
      .slice(0, 6)
      .map(p => ({
        name: p.product_name,
        brand: p.brands || '',
        cals: p.nutriments['energy-kcal_100g'],
        protein: p.nutriments['proteins_100g'] || 0,
        carbs: p.nutriments['carbohydrates_100g'] || 0,
        fat: p.nutriments['fat_100g'] || 0,
        source: 'db',
        per: 100,
        unit: 'g'
      }));
  } catch (e) {
    return [];
  }
}

async function estimateWithAI(q, apiKey) {
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 300,
        messages: [{
          role: 'user',
          content: `Estimate the nutritional content per 100g for: "${q}". Reply ONLY with valid JSON in this exact format: {"name":"<name>","cals":<number>,"protein":<number>,"carbs":<number>,"fat":<number>}. Numbers should be per 100g. No explanation, no markdown.`
        }]
      })
    });

    const data = await res.json();
    const text = data.content[0].text.trim();
    const parsed = JSON.parse(text);
    return [{ ...parsed, source: 'ai', per: 100, unit: 'g' }];
  } catch (e) {
    return [];
  }
}

async function triggerAIEstimate(q) {
  const aiKey = localStorage.getItem('nourish_ai_key');
  if (!aiKey) { toast('Add your API key first', 'error'); return; }

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = `<div class="result-item" style="cursor:default">
    <span class="result-name" style="color:var(--blue)"><span class="loading-dots">âœ¦ Estimating with AI</span></span>
  </div>`;
  resultsEl.classList.add('visible');

  const results = await estimateWithAI(q, aiKey);

  if (!results.length) {
    resultsEl.innerHTML = `<div class="result-item" style="cursor:default">
      <span class="result-name" style="color:var(--red)">AI estimation failed â€” check your API key</span>
    </div>`;
    return;
  }

  resultsEl.innerHTML = results.map((r, i) =>
    `<div class="result-item" onclick="selectFood(${i})">
      <div style="flex:1;min-width:0">
        <div class="result-name">${r.name}</div>
        <div class="result-brand" style="color:var(--text3)">AI estimated â€” values are approximate</div>
      </div>
      <span class="result-source source-ai">AI est.</span>
      <div class="result-cals">${ri(r.cals)} kcal/100g</div>
    </div>`
  ).join('');

  resultsEl._results = results;
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectFood(idx) {
  const results = document.getElementById('results')._results;
  selectedFood = results[idx];

  document.getElementById('modal-food-name').textContent = selectedFood.name;
  document.getElementById('modal-food-source').textContent = selectedFood.source === 'ai' ? 'âœ¦ AI estimated' : 'â— from Open Food Facts database';
  document.getElementById('modal-qty').value = 100;
  document.getElementById('modal-unit').value = selectedFood.unit || 'g';
  document.getElementById('modal').classList.add('visible');
  updateModalPreview();
  setTimeout(() => document.getElementById('modal-qty').select(), 50);
}

function updateModalPreview() {
  if (!selectedFood) return;
  const qty = parseFloat(document.getElementById('modal-qty').value) || 100;
  const unit = document.getElementById('modal-unit').value;

  // Simple multiplier: treat 1 portion = 100g equivalent; oz = 28.35g
  let mult = qty / (selectedFood.per || 100);
  if (unit === 'oz') mult = (qty * 28.35) / (selectedFood.per || 100);

  const cals = ri(selectedFood.cals * mult);
  const protein = r(selectedFood.protein * mult);
  const carbs = r(selectedFood.carbs * mult);
  const fat = r(selectedFood.fat * mult);

  document.getElementById('modal-preview').innerHTML =
    `${cals} kcal &nbsp;Â·&nbsp; P ${protein}g &nbsp;Â·&nbsp; C ${carbs}g &nbsp;Â·&nbsp; F ${fat}g`;
}

function closeModal() {
  document.getElementById('modal').classList.remove('visible');
  selectedFood = null;
}

function confirmAdd() {
  if (!selectedFood) return;
  const qty = parseFloat(document.getElementById('modal-qty').value) || 100;
  const unit = document.getElementById('modal-unit').value;

  let mult = qty / (selectedFood.per || 100);
  if (unit === 'oz') mult = (qty * 28.35) / (selectedFood.per || 100);

  const entry = {
    name: selectedFood.name,
    qty, unit,
    cals: selectedFood.cals * mult,
    protein: selectedFood.protein * mult,
    carbs: selectedFood.carbs * mult,
    fat: selectedFood.fat * mult,
    source: selectedFood.source,
    addedAt: new Date().toISOString()
  };

  const items = getDay();
  items.push(entry);
  saveDay(items);

  closeModal();
  document.getElementById('results').classList.remove('visible');
  document.getElementById('food-search').value = '';

  renderLog();
  renderSummary();
  toast('Added ' + entry.name, 'success');
}

// Close modal on overlay click
document.getElementById('modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveAiKey() {
  localStorage.setItem('nourish_ai_key', document.getElementById('ai-key').value);
}

function saveSheetsUrl() {
  localStorage.setItem('nourish_sheets_url', document.getElementById('sheets-url').value);
}

function exportCSV() {
  const rows = [['Date', 'Food', 'Qty', 'Unit', 'Calories', 'Protein (g)', 'Carbs (g)', 'Fat (g)', 'Source']];

  Object.entries(allData).sort().forEach(([date, items]) => {
    items.forEach(item => {
      rows.push([date, item.name, item.qty || 100, item.unit || 'g', ri(item.cals), r(item.protein), r(item.carbs), r(item.fat), item.source]);
    });
  });

  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'nourish-log.csv';
  a.click();
  toast('CSV downloaded', 'success');
}

async function exportToSheets() {
  const url = document.getElementById('sheets-url').value.trim();
  if (!url) {
    toast('Paste your Apps Script URL first', 'error');
    return;
  }

  const items = getDay();
  if (items.length === 0) {
    toast('No items to sync for this day', 'error');
    return;
  }

  const totals = getTotals(items);
  const btn = document.getElementById('sheets-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-dots">Syncing</span>';

  const payload = {
    date: currentDate,
    totalCals: ri(totals.cals),
    totalProtein: r(totals.protein),
    totalCarbs: r(totals.carbs),
    totalFat: r(totals.fat),
    items: items.map(i => `${i.name} (${ri(i.cals)} kcal)`).join('; ')
  };

  try {
    await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    toast('Synced to Google Sheets âœ“', 'success');
  } catch (e) {
    toast('Sync failed â€” check your URL', 'error');
  }

  btn.disabled = false;
  btn.innerHTML = 'â†‘ Sync to Sheets';
}

function showSheetsHelp() {
  alert(`To connect Google Sheets:\n\n1. Open Google Sheets and create a new spreadsheet\n2. Go to Extensions â†’ Apps Script\n3. Paste this code:\n\nfunction doPost(e) {\n  var data = JSON.parse(e.postData.contents);\n  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();\n  sheet.appendRow([data.date, data.totalCals, data.totalProtein, data.totalCarbs, data.totalFat, data.items]);\n  return ContentService.createTextOutput('OK');\n}\n\n4. Deploy â†’ New deployment â†’ Web app\n5. Set access to "Anyone"\n6. Copy the URL and paste it above`);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderLog();
renderSummary();
</script>
</body>
</html>
